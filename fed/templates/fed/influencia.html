{% extends "base.html" %}
{% block extratitle %}Area de influencia{% endblock %}
{% block extrahead %}
<script type="text/javascript">
    var map;
    var markers = new Array();
    $(document).ready(function(){

        var infowindow = new google.maps.InfoWindow();

        var myLatlng = new google.maps.LatLng(13,-85);
        var myOptions = {
            zoom: 7,
            mapTypeControl: false,
            center: myLatlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        }
        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

        $('#influencia').submit(function(){
            //var csrf = $('[name=csrfmiddlewaretoken]').val();
            if(checkear()){
                var datos = $('#influencia').serialize();
                $.post('/influencia/', datos,
                function(data){
                    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
                    $.each(data, function(i, item){
                        markers.push(new Array(item.punto[0], item.punto[1]));
                        var marker = new google.maps.Marker({
                            position: new google.maps.LatLng(item.punto[0], item.punto[1]),
                            map: map,
                            title:item.municipio
                        });
                        google.maps.event.addListener(marker, 'click', function() {
                            infowindow.open(map, marker);
                            var text = '<div class="infowindow">'+item.municipio+'<br><ul>';
                            $.each(item.proyectos, function(i, item){
                                text += '<li><a style="color:#7F7F7F;"href="/proyecto/' + item.id +'/">' + item.nombre + '</a></li>';
                            });
                            text += '</ul></div>';
                            infowindow.setContent(text);
                        });
                    });
                }, "json");
                return false;
            }
        });
        $('#guardar').click(function(){            
            var centro = map.getCenter();
            var zoom = map.getZoom();
            var url = 'http://maps.google.com/maps/api/staticmap?center='+centro['b']+','+centro['c']+'&size=600x500&maptype=roadmap';
            for (i=0; i < markers.length; i++){
                url += '&markers=color:red|'+markers[i][0]+','+markers[i][1]+'';
            }
            url += '&sensor=false&zoom='+map.getZoom();
            window.open(url, '_blank');
        });
        
    });
    function checkear(){
        var org, resul, per;
        if($('#id_organizacion').val() == null){
            alert('Seleccione una organizaciÃ³n');
            org = false;
        }else{
            org = true;
        }
        if($('#id_resultado').val() == null){
            alert('Seleccione un resultado');
            resul = false;
        }else{
            resul = true;
        }
        if($('#id_periodo').val() == null){
            alert('Seleccione un periodo');
            per = false;
        }else{
            per = true;
        }
        
        if(org && resul && per){
            return true;
        }else{
            return false;
        }

    }
</script>
{% endblock %}
{% block contenido %}
<div>
    <form action="." method="POST" id="influencia">{% csrf_token %}
        <table>
            {{form.as_table}}
        </table>
        <input type="submit" value="Enviar">
    </form>
    <button name="png" id="guardar">Guardar Mapa</button>
</div>
{{municipios}}

<div class="mapa">
    <div id="map_canvas">

    </div>
</div>

{% endblock %}

